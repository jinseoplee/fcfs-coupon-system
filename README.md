# 선착순 쿠폰 발급 시스템

## 1. 설계 목표

1차 목표는 동시 요청 환경에서도 데이터 정합성을 보장하는 것이다.

성능 최적화는 정합성이 확보된 이후 단계적으로 수행한다.

---

## 2. 정합성 정의

다음 조건은 항상 만족해야 한다.

- 발급 수가 총 수량을 초과하지 않는다.
- 같은 사용자가 두 번 발급받지 않는다.
- 발급 성공은 부분 반영 상태를 허용하지 않는다.

---

## 3. 문제 정의

다수의 사용자가 동시에 쿠폰 발급을 요청하는 환경에서 다음과 같은 위험이 존재한다.

- 경쟁 조건으로 인한 초과 발급
- 동일 사용자 중복 발급
- 발급 처리 중 일부 연산만 반영되는 부분 반영 문제

---

## 4. 설계 원칙

정합성을 보장하기 위해 다음 원칙을 따른다.

1. DB를 단일 진실 소스(Source of Truth)로 사용한다.
2. 애플리케이션 메모리 기반 락에 의존하지 않는다.
3. 정합성은 DB 제약 및 조건부 업데이트로 강제한다.
4. 발급 과정은 단일 트랜잭션으로 수행한다.

---

## 5. 해결 전략

- (coupon_id, user_id) UNIQUE 제약으로 중복 발급을 차단한다.
- issued_count 조건부 UPDATE로 초과 발급을 차단한다.
- 모든 발급 처리는 단일 트랜잭션 내에서 수행한다.
- 발급은 발급 레코드 생성과 수량 증가가 모두 성공한 경우에만 커밋하고, 그렇지 않으면 롤백한다.
